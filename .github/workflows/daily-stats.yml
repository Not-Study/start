name: Daily Study Stats

on:
  schedule:
    # æ¯å¤© UTC æ—¶é—´ 16:00 è¿è¡Œ (åŒ—äº¬æ—¶é—´ 00:00)
    - cron: "0 16 * * *"
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write

jobs:
  collect-stats:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Collect commit statistics
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          ORG_NAME: ${{ github.repository_owner }}
        run: |
          # åˆ›å»ºä»Šå¤©çš„æ—¥æœŸæ–‡ä»¶å¤¹
          DATE=$(date -u -d '-8 hours' +%Y-%m-%d)
          RECORD_DIR="records/${DATE}"
          mkdir -p "${RECORD_DIR}"

          echo "# å­¦ä¹ æ‰“å¡ç»Ÿè®¡" > "${RECORD_DIR}/README.md"
          echo "" >> "${RECORD_DIR}/README.md"
          echo "**æ—¥æœŸ**: ${DATE}" >> "${RECORD_DIR}/README.md"
          echo "" >> "${RECORD_DIR}/README.md"
          echo "## æ‰“å¡æƒ…å†µ" >> "${RECORD_DIR}/README.md"
          echo "" >> "${RECORD_DIR}/README.md"

          # è·å–ç»„ç»‡ä¸‹æ‰€æœ‰ä»“åº“
          echo "æ­£åœ¨è·å–ç»„ç»‡ ${ORG_NAME} çš„ä»“åº“åˆ—è¡¨..."
          repos=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
            "https://api.github.com/orgs/${ORG_NAME}/repos?per_page=100" | \
            jq -r '.[].name' | grep "^not-study-" || true)

          if [ -z "$repos" ]; then
            echo "æœªæ‰¾åˆ°ç¬¦åˆå‘½åè§„èŒƒçš„å­¦ä¹ ä»“åº“" >> "${RECORD_DIR}/README.md"
            echo "âš ï¸ æœªæ‰¾åˆ°ä»»ä½• not-study-* ä»“åº“"
          else
            echo "| ä»“åº“ | ç”¨æˆ· | æäº¤æ•° | æäº¤ä¿¡æ¯ |" >> "${RECORD_DIR}/README.md"
            echo "|------|------|--------|----------|" >> "${RECORD_DIR}/README.md"

            total_commits=0
            active_users=0
            total_repos=$(echo "$repos" | wc -l)

            # è®¡ç®—ä»Šå¤©çš„å¼€å§‹å’Œç»“æŸæ—¶é—´ (UTC-8 åŒ—äº¬æ—¶é—´)
            START_TIME=$(date -u -d "${DATE} 00:00:00 +8 hours" --iso-8601=seconds)
            END_TIME=$(date -u -d "${DATE} 23:59:59 +8 hours" --iso-8601=seconds)

            for repo in $repos; do
              echo "æ­£åœ¨å¤„ç†ä»“åº“: ${repo}"
              username="${repo#not-study-}"

              # è·å–ä»Šå¤©çš„ commits
              commits=$(curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                "https://api.github.com/repos/${ORG_NAME}/${repo}/commits?since=${START_TIME}&until=${END_TIME}" | \
                jq -r '.[] | "\(.commit.message | split("\n")[0])"' || echo "")

              commit_count=$(echo "$commits" | grep -c "." || echo "0")
              if [ -z "$commits" ] || [ "$commits" = "" ]; then
                commit_count=0
              fi

              if [ $commit_count -gt 0 ]; then
                active_users=$((active_users + 1))
                total_commits=$((total_commits + commit_count))

                # è·å–æäº¤è¯¦æƒ…ï¼Œç”¨é¡¿å·åˆ†éš”
                commit_details=$(echo "$commits" | head -3 | tr '\n' 'ã€' | sed 's/ã€$//')
                if [ -z "$commit_details" ]; then
                  commit_details="æ— è¯¦æƒ…"
                fi
                # å¦‚æœè¶…è¿‡3æ¡ï¼Œæ·»åŠ çœç•¥å·
                if [ $commit_count -gt 3 ]; then
                  commit_details="${commit_details}..."
                fi

                echo "| [${repo}](https://github.com/${ORG_NAME}/${repo}) | ${username} | ${commit_count} | ${commit_details} |" >> "${RECORD_DIR}/README.md"

                # ä¿å­˜è¯¦ç»†çš„ JSON æ•°æ®
                curl -s -H "Authorization: token ${GITHUB_TOKEN}" \
                  "https://api.github.com/repos/${ORG_NAME}/${repo}/commits?since=${START_TIME}&until=${END_TIME}" \
                  > "${RECORD_DIR}/${repo}.json"
              else
                echo "| [${repo}](https://github.com/${ORG_NAME}/${repo}) | ${username} | 0 | æœªæ‰“å¡ |" >> "${RECORD_DIR}/README.md"
              fi
            done

            echo "" >> "${RECORD_DIR}/README.md"
            echo "## ç»Ÿè®¡æ‘˜è¦" >> "${RECORD_DIR}/README.md"
            echo "" >> "${RECORD_DIR}/README.md"
            echo "- æ€»ä»“åº“æ•°: ${total_repos}" >> "${RECORD_DIR}/README.md"
            echo "- æ‰“å¡äººæ•°: ${active_users}" >> "${RECORD_DIR}/README.md"
            echo "- æ€»æäº¤æ•°: ${total_commits}" >> "${RECORD_DIR}/README.md"
          fi

          echo "" >> "${RECORD_DIR}/README.md"
          echo "---" >> "${RECORD_DIR}/README.md"
          echo "" >> "${RECORD_DIR}/README.md"
          echo "_ç»Ÿè®¡æ—¶é—´: ${DATE} 00:00 (UTC+8)_" >> "${RECORD_DIR}/README.md"

      - name: Commit and push statistics
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          git add records/

          if git diff --staged --quiet; then
            echo "æ²¡æœ‰æ–°çš„ç»Ÿè®¡æ•°æ®"
          else
            DATE=$(date -u -d '-8 hours' +%Y-%m-%d)
            git commit -m "ğŸ“Š ${DATE}"
            git push
          fi
